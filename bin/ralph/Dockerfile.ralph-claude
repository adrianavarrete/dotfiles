# Dockerfile.ralph-claude
# Custom Claude Code image for ralph_claude.sh iteration script
# Base: Official Node.js Alpine image

FROM node:20-alpine

# Install git and bash (Alpine Linux base)
RUN apk add --no-cache \
    git \
    bash

# Install Claude Code CLI globally via npm
RUN npm install -g @anthropic-ai/claude-code

# Create user matching host UID/GID to avoid file ownership issues
# These are passed as build arguments
ARG USER_ID=1000
ARG GROUP_ID=1000

# Create group and user with specified IDs (Alpine uses addgroup/adduser)
# First check if group exists, otherwise create it
RUN (getent group ${GROUP_ID} && echo "Group ${GROUP_ID} exists") || addgroup -g ${GROUP_ID} claude

# Create user - if UID exists, we'll use a different name but same UID
RUN adduser -u ${USER_ID} -D -s /bin/bash claude 2>/dev/null || \
    (echo "UID ${USER_ID} exists, using existing user" && \
     USER_NAME=$(getent passwd ${USER_ID} | cut -d: -f1) && \
     ln -sf /home/$USER_NAME /home/claude)

# Create directories for Claude Code config and Anthropic credentials
RUN mkdir -p /home/claude/.claude /home/claude/.anthropic || true && \
    chown -R ${USER_ID}:${GROUP_ID} /home/claude 2>/dev/null || true

# Switch to non-root user
USER claude

# Set working directory
WORKDIR /workspace

# Default command (can be overridden)
CMD ["claude", "--help"]
